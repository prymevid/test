name: Stream Music Video to YouTube

env:
  # Video file configuration
  VIDEO_FILE_PREFIX: "k"
  VIDEO_FILE_RANGE_START: 1
  VIDEO_FILE_RANGE_END: 17
  VIDEO_FILE_EXTENSION: ".mp4"

  # Stream configuration
  CLOUDFLARE_R2_URL: "https://pub-b19fa9b28a6640638cebf21d187c3e25.r2.dev/new/"
  YOUTUBE_RTMP_URL: "rtmp://a.rtmp.youtube.com/live2/"
  
  # TWO YouTube stream keys
  YOUTUBE_STREAM_KEY_A: "sdf6-cj08-0cbw-5xh4-8kus"
  YOUTUBE_STREAM_KEY_B: "zhz6-63as-rd13-wd4b-8kvy"

  # Runtime configuration (minutes)
  BASE_RUNTIME: 20000
  START_JITTER_MAX: 3
  END_JITTER_MAX: 10

  # YouTube preparation delay (seconds)
  YOUTUBE_PREP_DELAY: 10

  # FFmpeg settings
  VIDEO_CODEC: "libx264"
  VIDEO_PRESET: "veryfast"
  VIDEO_BITRATE: "1500k"
  BUFFER_SIZE: "3000k"
  AUDIO_CODEC: "aac"
  AUDIO_BITRATE: "96k"
  AUDIO_SAMPLE_RATE: "44100"
  AUDIO_CHANNELS: "2"

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    concurrency:
      group: youtube-stream-group
      cancel-in-progress: true

    steps:
      - name: "üì• Checkout repository"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: "üîë Select and update stream key with logging"
        id: select-key
        run: |
          echo "========================================"
          echo "üîë STREAM KEY SELECTION PHASE"
          echo "========================================"
          
          # Define key file path
          KEY_FILE="last_stream_key.txt"
          
          # Check if key file exists, create if it doesn't
          if [ ! -f "$KEY_FILE" ]; then
            echo "‚ÑπÔ∏è  No previous key file found. Creating new file..."
            echo "KEY_A" > "$KEY_FILE"
            echo "‚úÖ Created new key file with default KEY_A"
            LAST_KEY="KEY_A"
          else
            LAST_KEY=$(cat "$KEY_FILE")
            echo "‚ÑπÔ∏è  Found previous key: $LAST_KEY"
          fi
          
          # Determine which key to use (alternate between A and B)
          if [ "$LAST_KEY" = "KEY_A" ]; then
            CURRENT_KEY="KEY_B"
            YOUTUBE_STREAM_KEY="$YOUTUBE_STREAM_KEY_B"
            echo "üîÑ Switching from KEY_A to KEY_B"
          else
            CURRENT_KEY="KEY_A"
            YOUTUBE_STREAM_KEY="$YOUTUBE_STREAM_KEY_A"
            echo "üîÑ Switching from KEY_B to KEY_A"
          fi
          
          # Update the key file BEFORE streaming starts
          echo "$CURRENT_KEY" > "$KEY_FILE"
          echo "‚úÖ Updated key file with: $CURRENT_KEY (before stream starts)"
          
          # Set outputs for later use
          echo "current-key=$CURRENT_KEY" >> $GITHUB_OUTPUT
          echo "youtube-stream-key=$YOUTUBE_STREAM_KEY" >> $GITHUB_OUTPUT
          
          echo "========================================"
          echo "üéØ Selected key: $CURRENT_KEY"
          echo "========================================"

      - name: "üîß Install FFmpeg"
        run: |
          echo "========================================"
          echo "üîß FFMPEG INSTALLATION PHASE"
          echo "========================================"
          echo "‚ÑπÔ∏è  Updating package list..."
          sudo apt update
          echo "‚ÑπÔ∏è  Installing FFmpeg..."
          sudo apt install -y ffmpeg
          echo "‚úÖ FFmpeg installation complete"
          ffmpeg -version | head -1

      - name: "üé≤ Select random video"
        id: random-video
        run: |
          echo "========================================"
          echo "üé≤ VIDEO SELECTION PHASE"
          echo "========================================"
          
          # Calculate range
          RANGE_START=$VIDEO_FILE_RANGE_START
          RANGE_END=$VIDEO_FILE_RANGE_END
          RANGE_SIZE=$((RANGE_END - RANGE_START + 1))
          
          echo "‚ÑπÔ∏è  Video range: $RANGE_START to $RANGE_END ($RANGE_SIZE videos)"
          
          # Generate random number
          RANDOM_NUM=$(( RANDOM % RANGE_SIZE + RANGE_START ))
          VIDEO_FILE="${VIDEO_FILE_PREFIX}${RANDOM_NUM}${VIDEO_FILE_EXTENSION}"
          
          echo "‚úÖ Selected video: $VIDEO_FILE"
          echo "üîó Full URL: ${CLOUDFLARE_R2_URL}${VIDEO_FILE}"
          
          # Set output
          echo "video-file=$VIDEO_FILE" >> $GITHUB_OUTPUT
          
          echo "========================================"

      - name: "‚è±Ô∏è Calculate runtime with jitter"
        id: runtime
        run: |
          echo "========================================"
          echo "‚è±Ô∏è RUNTIME CALCULATION PHASE"
          echo "========================================"
          
          # Calculate jitters
          START_JITTER_SECONDS=$(( RANDOM % ($START_JITTER_MAX * 60 + 1) ))
          END_JITTER_SECONDS=$(( RANDOM % ($END_JITTER_MAX * 60 + 1) ))
          TOTAL_SECONDS=$(( BASE_RUNTIME * 60 + START_JITTER_SECONDS + END_JITTER_SECONDS ))
          
          # Convert to hours/minutes for readability
          HOURS=$(( TOTAL_SECONDS / 3600 ))
          MINUTES=$(( (TOTAL_SECONDS % 3600) / 60 ))
          SECONDS=$(( TOTAL_SECONDS % 60 ))
          
          echo "‚ÑπÔ∏è  Base runtime: $BASE_RUNTIME minutes"
          echo "‚ÑπÔ∏è  Start jitter: $START_JITTER_SECONDS seconds"
          echo "‚ÑπÔ∏è  End jitter: $END_JITTER_SECONDS seconds"
          echo "‚úÖ Total runtime: ${TOTAL_SECONDS} seconds"
          echo "   (Approx: ${HOURS}h ${MINUTES}m ${SECONDS}s)"
          
          # Set outputs
          echo "start-jitter=$START_JITTER_SECONDS" >> $GITHUB_OUTPUT
          echo "total-runtime=$TOTAL_SECONDS" >> $GITHUB_OUTPUT
          
          echo "========================================"

      - name: "‚è≥ Wait for start jitter"
        run: |
          echo "========================================"
          echo "‚è≥ START JITTER DELAY PHASE"
          echo "========================================"
          echo "‚ÑπÔ∏è  Waiting for ${{ steps.runtime.outputs.start-jitter }} seconds..."
          sleep ${{ steps.runtime.outputs.start-jitter }}
          echo "‚úÖ Start jitter delay complete"
          echo "========================================"

      - name: "üü° Allow YouTube ingest preparation"
        run: |
          echo "========================================"
          echo "üü° YOUTUBE PREPARATION PHASE"
          echo "========================================"
          echo "‚ÑπÔ∏è  Allowing YouTube ${YOUTUBE_PREP_DELAY} seconds to prepare..."
          sleep ${YOUTUBE_PREP_DELAY}
          echo "‚úÖ YouTube preparation delay complete"
          echo "========================================"

      - name: "üî¥ Stream to YouTube (STABLE & SAFE)"
        run: |
          echo "========================================"
          echo "üî¥ STREAMING PHASE"
          echo "========================================"
          echo "‚ÑπÔ∏è  Starting stream with the following configuration:"
          echo "   - Video: ${{ steps.random-video.outputs.video-file }}"
          echo "   - Stream key: ${{ steps.select-key.outputs.current-key }}"
          echo "   - Duration: ${{ steps.runtime.outputs.total-runtime }} seconds"
          echo "   - YouTube RTMP: ${YOUTUBE_RTMP_URL}[key]"
          echo ""
          echo "üöÄ Initializing FFmpeg stream..."
          
          # Create stream script
          cat > stream.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail
          
          echo "üî¥ FFMPEG STREAM STARTING..."
          echo "üì∫ Source: ${CLOUDFLARE_R2_URL}${VIDEO_FILE}"
          echo "üì° Destination: ${YOUTUBE_RTMP_URL}${YOUTUBE_STREAM_KEY}"
          echo "‚è±Ô∏è  Duration: ${TOTAL_RUNTIME} seconds"
          echo ""
          
          # Start FFmpeg with detailed logging
          ffmpeg \
            -re \
            -fflags +genpts \
            -stream_loop -1 \
            -thread_queue_size 512 \
            -i "${CLOUDFLARE_R2_URL}${VIDEO_FILE}" \
            -r 30 -g 60 -keyint_min 60 -sc_threshold 0 \
            -force_key_frames "expr:gte(t,n_forced*2)" \
            -c:v libx264 -preset veryfast \
            -b:v 1500k -maxrate 1500k -bufsize 3000k \
            -pix_fmt yuv420p -profile:v high -level 4.2 \
            -c:a aac -b:a 96k \
            -ar 44100 -ac 2 \
            -af aresample=async=1:first_pts=0 \
            -f flv \
            -flvflags no_duration_filesize \
            -rtmp_live live \
            -reconnect 1 \
            -reconnect_streamed 1 \
            -reconnect_delay_max 2 \
            "${YOUTUBE_RTMP_URL}${YOUTUBE_STREAM_KEY}" 2>&1 | \
            while IFS= read -r line; do
              echo "[FFMPEG] $line"
            done &
          
          FFMPEG_PID=$!
          echo "‚úÖ FFmpeg started with PID: $FFMPEG_PID"
          
          # Monitor the stream duration
          echo "‚è±Ô∏è  Streaming for ${TOTAL_RUNTIME} seconds..."
          sleep ${TOTAL_RUNTIME}
          
          echo "üõë Stopping stream gracefully..."
          kill -SIGINT $FFMPEG_PID
          wait $FFMPEG_PID || true
          
          echo "‚úÖ Stream finished gracefully"
          EOF

          chmod +x stream.sh

          # Export environment variables
          export VIDEO_FILE="${{ steps.random-video.outputs.video-file }}"
          export TOTAL_RUNTIME="${{ steps.runtime.outputs.total-runtime }}"
          export YOUTUBE_STREAM_KEY="${{ steps.select-key.outputs.youtube-stream-key }}"
          export CLOUDFLARE_R2_URL="$CLOUDFLARE_R2_URL"
          export YOUTUBE_RTMP_URL="$YOUTUBE_RTMP_URL"

          # Execute stream script
          ./stream.sh
          
          echo "========================================"
          echo "‚úÖ STREAMING COMPLETE"
          echo "========================================"

      - name: "üíæ Commit and push key state"
        if: always()
        run: |
          echo "========================================"
          echo "üíæ KEY STATE COMMIT PHASE"
          echo "========================================"
          
          echo "‚ÑπÔ∏è  Configuring git..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          echo "‚ÑπÔ∏è  Checking for changes to last_stream_key.txt..."
          if git diff --quiet last_stream_key.txt; then
            echo "‚úÖ No changes to key file (already updated before stream)"
          else
            echo "üìù Changes detected, committing key file..."
            git add last_stream_key.txt
            git commit -m "Update last used stream key to $(cat last_stream_key.txt)" || echo "‚ö†Ô∏è  No changes to commit"
          fi
          
          echo "üöÄ Pushing changes to repository..."
          git push origin HEAD:${{ github.ref_name }} || echo "‚ö†Ô∏è  Push failed or no changes"
          
          echo "‚úÖ Key state management complete"
          echo "========================================"

      - name: "‚úÖ Stream completion summary"
        if: always()
        run: |
          echo "========================================"
          echo "üéâ STREAM WORKFLOW COMPLETE"
          echo "========================================"
          echo "üìä SUMMARY:"
          echo "   - Stream key used: ${{ steps.select-key.outputs.current-key }}"
          echo "   - Video played: ${{ steps.random-video.outputs.video-file }}"
          echo "   - Total runtime: ${{ steps.runtime.outputs.total-runtime }} seconds"
          echo "   - Next stream will use: $([ "${{ steps.select-key.outputs.current-key }}" = "KEY_A" ] && echo "KEY_B" || echo "KEY_A")"
          echo "========================================"
          echo "‚úÖ Stream finished successfully"
          echo "========================================"
