name: Stream Music Video to YouTube

# CONFIGURATION SECTION - Modify these values as needed
env:
  # Video file configuration
  VIDEO_FILE_PREFIX: "k"              # Prefix for video files
  VIDEO_FILE_RANGE_START: 1           # Start of random range for video files
  VIDEO_FILE_RANGE_END: 17            # End of random range for video files
  VIDEO_FILE_EXTENSION: ".mp4"        # Extension for video files
  
  # Stream configuration
  CLOUDFLARE_R2_URL: "https://pub-b19fa9b28a6640638cebf21d187c3e25.r2.dev/new/"  # Base URL for videos
  YOUTUBE_RTMP_URL: "rtmp://a.rtmp.youtube.com/live2/"  # Base RTMP URL for YouTube
  YOUTUBE_STREAM_KEY: "qa5q-hr1q-htsj-r7x6-3c05"        # YouTube stream key
  
  # Runtime configuration (in minutes)
  BASE_RUNTIME: 2                     # Base runtime that will always run
  START_JITTER_MAX: 1                 # Maximum ADDITIONAL random time before starting (0-1 minutes)
  END_JITTER_MAX: 2                   # Maximum ADDITIONAL random time after base runtime (0-2 minutes)
  
  # FFmpeg settings
  VIDEO_CODEC: "libx264"
  VIDEO_PRESET: "veryfast"
  VIDEO_BITRATE: "1000k"
  AUDIO_CODEC: "aac"
  AUDIO_BITRATE: "96k"
  AUDIO_SAMPLE_RATE: "44100"
  AUDIO_CHANNELS: "2"
  # Additional FFmpeg settings for better streaming
  KEYFRAME_INTERVAL: 60              # Keyframe interval in seconds
  BUFFER_SIZE: "2000k"                # Buffer size for stable streaming

# Trigger configuration - Now uses workflow_dispatch for manual triggering
on:
  workflow_dispatch:  # Allows manual triggering via GitHub UI or API

jobs:
  stream:
    runs-on: ubuntu-latest
    concurrency:
      group: youtube-stream-group  # Ensures only one instance runs at a time
      cancel-in-progress: true     # Cancel any in-progress workflows when a new one starts

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install FFmpeg
        run: |
          echo "üîß Installing FFmpeg..."
          sudo apt update
          sudo apt install ffmpeg -y
          echo "‚úÖ FFmpeg installation completed"

      - name: Generate random video file
        id: random-video
        run: |
          echo "üìπ Selecting a random video file..."
          # Generate a random number within the specified range
          RANDOM_NUM=$(( RANDOM % ($VIDEO_FILE_RANGE_END - $VIDEO_FILE_RANGE_START + 1) + $VIDEO_FILE_RANGE_START ))
          VIDEO_FILE="${VIDEO_FILE_PREFIX}${RANDOM_NUM}${VIDEO_FILE_EXTENSION}"
          echo "video-file=${VIDEO_FILE}" >> $GITHUB_OUTPUT
          echo "‚úÖ Selected video file: ${VIDEO_FILE}"

      - name: Calculate runtime with jitter
        id: runtime
        run: |
          echo "‚è±Ô∏è Calculating stream runtime with jitter..."
          echo "   Jitter is ADDITIONAL random time that will be added to the base runtime"
          
          # Calculate start jitter (randomly select 0 to START_JITTER_MAX minutes)
          START_JITTER=$(( RANDOM % ($START_JITTER_MAX + 1) ))
          echo "start-jitter=${START_JITTER}" >> $GITHUB_OUTPUT
          
          # Calculate end jitter (randomly select 0 to END_JITTER_MAX minutes)
          END_JITTER=$(( RANDOM % ($END_JITTER_MAX + 1) ))
          echo "end-jitter=${END_JITTER}" >> $GITHUB_OUTPUT
          
          # Calculate total runtime (BASE_RUNTIME + all jitter values)
          # Jitter is ADDITIONAL time, so we ADD it to the base runtime
          TOTAL_RUNTIME=$(( $BASE_RUNTIME + $START_JITTER + $END_JITTER ))
          echo "total-runtime=${TOTAL_RUNTIME}" >> $GITHUB_OUTPUT
          
          echo "üìä Runtime Calculation:"
          echo "   Base runtime: ${BASE_RUNTIME} minutes (guaranteed)"
          echo "   Start jitter: ${START_JITTER} minutes (ADDITIONAL random wait before starting)"
          echo "   End jitter: ${END_JITTER} minutes (ADDITIONAL random time after base runtime)"
          echo "   Total runtime: ${BASE_RUNTIME} + ${START_JITTER} + ${END_JITTER} = ${TOTAL_RUNTIME} minutes"

      - name: Wait for start jitter
        run: |
          echo "‚è≥ Waiting for ADDITIONAL ${START_JITTER} minutes before starting the stream..."
          echo "   (This is the start jitter - random additional wait time)"
          sleep ${{ steps.runtime.outputs.start-jitter }}m
          echo "‚úÖ Initial wait completed, preparing to start stream"

      - name: Stream Cloudflare R2 video to YouTube
        run: |
          echo "üöÄ Starting stream to YouTube..."
          echo "üì° Stream URL: ${YOUTUBE_RTMP_URL}${YOUTUBE_STREAM_KEY}"
          echo "üìπ Video source: ${CLOUDFLARE_R2_URL}${{ steps.random-video.outputs.video-file }}"
          echo "‚è±Ô∏è Stream will run for exactly ${{ steps.runtime.outputs.total-runtime }} minutes"
          echo "   (This includes base runtime + all additional jitter time)"
          echo "üé¨ FFmpeg settings:"
          echo "   Video codec: ${VIDEO_CODEC} (${VIDEO_PRESET})"
          echo "   Video bitrate: ${VIDEO_BITRATE}"
          echo "   Audio codec: ${AUDIO_CODEC} (${AUDIO_BITRATE})"
          echo "   Keyframe interval: ${KEYFRAME_INTERVAL} seconds"
          
          # Stream with optimized settings for YouTube
          timeout ${{ steps.runtime.outputs.total-runtime }}m ffmpeg -re -stream_loop -1 \
            -i "${CLOUDFLARE_R2_URL}${{ steps.random-video.outputs.video-file }}" \
            -c:v ${VIDEO_CODEC} -preset ${VIDEO_PRESET} \
            -g ${KEYFRAME_INTERVAL} -keyint_min ${KEYFRAME_INTERVAL} -sc_threshold 0 \
            -b:v ${VIDEO_BITRATE} -maxrate ${VIDEO_BITRATE} -bufsize ${BUFFER_SIZE} \
            -pix_fmt yuv420p -profile:v baseline -level 3.1 \
            -c:a ${AUDIO_CODEC} -ar ${AUDIO_SAMPLE_RATE} -b:a ${AUDIO_BITRATE} -ac ${AUDIO_CHANNELS} \
            -f flv -flvflags no_duration_filesize \
            "${YOUTUBE_RTMP_URL}${YOUTUBE_STREAM_KEY}" || \
          echo "‚úÖ Stream completed or terminated after reaching the time limit"

      - name: Notification on completion
        if: always()
        run: |
          echo "üì¢ Stream Status Notification:"
          echo "   Status: ${{ job.status }}"
          echo "   Total runtime was exactly ${{ steps.runtime.outputs.total-runtime }} minutes."
          echo "   (Base: ${BASE_RUNTIME}min + Start jitter: ${{ steps.runtime.outputs.start-jitter }}min + End jitter: ${{ steps.runtime.outputs.end-jitter }}min)"
          echo "   Video streamed: ${{ steps.random-video.outputs.video-file }}"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Stream completed successfully!"
          else
            echo "‚ùå Stream encountered issues or was terminated unexpectedly."
          fi
