name: Stream Music Video to YouTube

env:
  # Video file configuration
  VIDEO_FILE_PREFIX: "k"
  VIDEO_FILE_RANGE_START: 1
  VIDEO_FILE_RANGE_END: 17
  VIDEO_FILE_EXTENSION: ".mp4"

  # Stream configuration
  CLOUDFLARE_R2_URL: "https://pub-b19fa9b28a6640638cebf21d187c3e25.r2.dev/new/"
  YOUTUBE_RTMP_URL: "rtmp://a.rtmp.youtube.com/live2/"
  YOUTUBE_STREAM_KEY: "sdf6-cj08-0cbw-5xh4-8kus"

  # Runtime configuration (minutes)
  BASE_RUNTIME: 20000
  START_JITTER_MAX: 3
  END_JITTER_MAX: 10

  # YouTube preparation delay
  YOUTUBE_PREP_DELAY: 10

  # FFmpeg settings (YouTube-safe, automatic)
  VIDEO_CODEC: "libx264"
  VIDEO_PRESET: "veryfast"
  VIDEO_BITRATE: "1000k"
  BUFFER_SIZE: "2000k"
  AUDIO_CODEC: "aac"
  AUDIO_BITRATE: "96k"
  AUDIO_SAMPLE_RATE: "44100"
  AUDIO_CHANNELS: "2"

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    concurrency:
      group: youtube-stream-group
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: Select random video
        id: random-video
        run: |
          RANDOM_NUM=$(( RANDOM % ($VIDEO_FILE_RANGE_END - $VIDEO_FILE_RANGE_START + 1) + $VIDEO_FILE_RANGE_START ))
          echo "video-file=${VIDEO_FILE_PREFIX}${RANDOM_NUM}${VIDEO_FILE_EXTENSION}" >> $GITHUB_OUTPUT

      - name: Calculate runtime
        id: runtime
        run: |
          START_JITTER_SECONDS=$(( RANDOM % ($START_JITTER_MAX * 60 + 1) ))
          END_JITTER_SECONDS=$(( RANDOM % ($END_JITTER_MAX * 60 + 1) ))
          TOTAL_SECONDS=$(( BASE_RUNTIME * 60 + START_JITTER_SECONDS + END_JITTER_SECONDS ))
          echo "start-jitter=${START_JITTER_SECONDS}" >> $GITHUB_OUTPUT
          echo "total-runtime=${TOTAL_SECONDS}" >> $GITHUB_OUTPUT
          echo "timeout=$((TOTAL_SECONDS + 3))" >> $GITHUB_OUTPUT

      - name: Wait for start jitter
        run: sleep ${{ steps.runtime.outputs.start-jitter }}

      - name: Prepare YouTube
        run: sleep ${YOUTUBE_PREP_DELAY}

      - name: Stream to YouTube (AUTO + STABLE)
        run: |
          cat > stream.sh << 'EOF'
          #!/bin/bash

          ffmpeg \
            -reconnect 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
            -re -stream_loop -1 \
            -thread_queue_size 512 \
            -i "${CLOUDFLARE_R2_URL}${{ steps.random-video.outputs.video-file }}" \
            -r 30 -g 60 -keyint_min 60 -sc_threshold 0 \
            -c:v ${VIDEO_CODEC} -preset ${VIDEO_PRESET} \
            -b:v ${VIDEO_BITRATE} -maxrate ${VIDEO_BITRATE} -bufsize ${BUFFER_SIZE} \
            -pix_fmt yuv420p -profile:v high -level 4.2 \
            -c:a ${AUDIO_CODEC} -b:a ${AUDIO_BITRATE} -ar ${AUDIO_SAMPLE_RATE} -ac ${AUDIO_CHANNELS} \
            -af aresample=async=1 \
            -f flv -flvflags no_duration_filesize \
            "${YOUTUBE_RTMP_URL}${YOUTUBE_STREAM_KEY}" &
          
          PID=$!
          sleep ${{ steps.runtime.outputs.total-runtime }}
          kill -SIGTERM $PID
          sleep 3
          kill -9 $PID 2>/dev/null || true
          EOF

          chmod +x stream.sh
          timeout ${{ steps.runtime.outputs.timeout }}s ./stream.sh || true

      - name: Done
        if: always()
        run: |
          echo "Stream finished"
          echo "Video: ${{ steps.random-video.outputs.video-file }}"
          echo "Duration: ${{ steps.runtime.outputs.total-runtime }} seconds"
