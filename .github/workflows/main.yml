name: Stream Music Video to YouTube

env:
  # Video file configuration
  VIDEO_FILE_PREFIX: "k"
  VIDEO_FILE_RANGE_START: 1
  VIDEO_FILE_RANGE_END: 17
  VIDEO_FILE_EXTENSION: ".mp4"

  # Stream configuration
  CLOUDFLARE_R2_URL: "https://pub-b19fa9b28a6640638cebf21d187c3e25.r2.dev/new/"
  YOUTUBE_RTMP_URL: "rtmp://a.rtmp.youtube.com/live2/"
  
  # TWO YouTube stream keys
  YOUTUBE_STREAM_KEY_A: "sdf6-cj08-0cbw-5xh4-8kus"  # Channel A
  YOUTUBE_STREAM_KEY_B: "zhz6-63as-rd13-wd4b-8kvy"  # Channel B

  # Runtime configuration (minutes)
  BASE_RUNTIME: 20000
  START_JITTER_MAX: 3
  END_JITTER_MAX: 10

  # YouTube preparation delay (seconds)
  YOUTUBE_PREP_DELAY: 10

  # FFmpeg settings (YouTube-safe)
  VIDEO_CODEC: "libx264"
  VIDEO_PRESET: "veryfast"
  VIDEO_BITRATE: "1500k"
  BUFFER_SIZE: "3000k"
  AUDIO_CODEC: "aac"
  AUDIO_BITRATE: "96k"
  AUDIO_SAMPLE_RATE: "44100"
  AUDIO_CHANNELS: "2"

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    concurrency:
      group: youtube-stream-group
      cancel-in-progress: true

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”‘ Select which key to use (Auto-toggle Aâ†”B)
        id: select-key
        run: |
          # Check if we have a saved key file
          if [ -f "last_stream_key.txt" ]; then
            echo "Found existing key file"
            LAST_KEY=$(cat last_stream_key.txt)
            echo "Last used key: $LAST_KEY"
            
            # Toggle to the other key
            if [ "$LAST_KEY" = "KEY_A" ]; then
              CURRENT_KEY="KEY_B"
              YOUTUBE_STREAM_KEY="$YOUTUBE_STREAM_KEY_B"
            else
              CURRENT_KEY="KEY_A"
              YOUTUBE_STREAM_KEY="$YOUTUBE_STREAM_KEY_A"
            fi
          else
            # First run - create file and start with KEY_A
            echo "No key file found - first run"
            CURRENT_KEY="KEY_A"
            YOUTUBE_STREAM_KEY="$YOUTUBE_STREAM_KEY_A"
            echo "$CURRENT_KEY" > last_stream_key.txt
            echo "Created key file with: $CURRENT_KEY"
          fi
          
          echo "Current key: $CURRENT_KEY"
          echo "Using YouTube Stream Key: $YOUTUBE_STREAM_KEY"
          
          # Set outputs
          echo "current-key=$CURRENT_KEY" >> $GITHUB_OUTPUT
          echo "youtube-stream-key=$YOUTUBE_STREAM_KEY" >> $GITHUB_OUTPUT
          
          # Save current key to file (will be committed later)
          echo "$CURRENT_KEY" > last_stream_key.txt

      - name: ğŸ”§ Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
          ffmpeg -version

      - name: ğŸ² Select random video
        id: random-video
        run: |
          set -e
          RANDOM_NUM=$(( RANDOM % ($VIDEO_FILE_RANGE_END - $VIDEO_FILE_RANGE_START + 1) + $VIDEO_FILE_RANGE_START ))
          VIDEO_FILE="${VIDEO_FILE_PREFIX}${RANDOM_NUM}${VIDEO_FILE_EXTENSION}"
          echo "Selected video: $VIDEO_FILE"
          echo "video-file=$VIDEO_FILE" >> $GITHUB_OUTPUT

      - name: â±ï¸ Calculate runtime
        id: runtime
        run: |
          set -e
          START_JITTER_SECONDS=$(( RANDOM % ($START_JITTER_MAX * 60 + 1) ))
          END_JITTER_SECONDS=$(( RANDOM % ($END_JITTER_MAX * 60 + 1) ))
          TOTAL_SECONDS=$(( BASE_RUNTIME * 60 + START_JITTER_SECONDS + END_JITTER_SECONDS ))

          echo "Start jitter: $START_JITTER_SECONDS seconds"
          echo "Total runtime: $TOTAL_SECONDS seconds"

          echo "start-jitter=$START_JITTER_SECONDS" >> $GITHUB_OUTPUT
          echo "total-runtime=$TOTAL_SECONDS" >> $GITHUB_OUTPUT

      - name: â³ Wait for start jitter
        run: |
          echo "Waiting start jitter..."
          sleep ${{ steps.runtime.outputs.start-jitter }}

      - name: ğŸŸ¡ Allow YouTube ingest preparation
        run: |
          echo "Preparing YouTube ingest..."
          sleep ${YOUTUBE_PREP_DELAY}

      - name: ğŸ”´ Stream to YouTube (CLEAN & STABLE)
        run: |
          cat > stream.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail

          log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
          }

          log "Starting FFmpeg stream to $CURRENT_KEY channel"

          ffmpeg \
            -re \
            -stream_loop -1 \
            -thread_queue_size 512 \
            -i "${CLOUDFLARE_R2_URL}${VIDEO_FILE}" \
            -r 30 -g 60 -keyint_min 60 -sc_threshold 0 \
            -c:v ${VIDEO_CODEC} -preset ${VIDEO_PRESET} \
            -b:v ${VIDEO_BITRATE} -maxrate ${VIDEO_BITRATE} -bufsize ${BUFFER_SIZE} \
            -pix_fmt yuv420p -profile:v high -level 4.2 \
            -c:a ${AUDIO_CODEC} -b:a ${AUDIO_BITRATE} \
            -ar ${AUDIO_SAMPLE_RATE} -ac ${AUDIO_CHANNELS} \
            -af aresample=async=1 \
            -f flv -flvflags no_duration_filesize \
            "${YOUTUBE_RTMP_URL}${YOUTUBE_STREAM_KEY}" &
          
          FFMPEG_PID=$!
          log "FFmpeg started (PID=$FFMPEG_PID)"

          sleep ${TOTAL_RUNTIME}

          log "Stopping FFmpeg gracefully (SIGINT)"
          kill -SIGINT $FFMPEG_PID

          log "Waiting for FFmpeg to close RTMP connection"
          wait $FFMPEG_PID || true

          log "FFmpeg exited cleanly"

          log "Cooldown to allow YouTube finalize stream"
          sleep 15

          log "Stream shutdown complete"
          EOF

          chmod +x stream.sh

          export VIDEO_FILE="${{ steps.random-video.outputs.video-file }}"
          export TOTAL_RUNTIME="${{ steps.runtime.outputs.total-runtime }}"
          export CURRENT_KEY="${{ steps.select-key.outputs.current-key }}"
          export YOUTUBE_STREAM_KEY="${{ steps.select-key.outputs.youtube-stream-key }}"

          ./stream.sh

      - name: ğŸ’¾ Commit and push key state for next run
        if: always()
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check status
          echo "Current directory:"
          pwd
          ls -la
          
          echo "Content of last_stream_key.txt:"
          cat last_stream_key.txt
          
          # Stage the file
          git add last_stream_key.txt
          
          # Check if there are changes to commit
          if ! git diff --cached --quiet; then
            echo "Committing changes to last_stream_key.txt"
            git commit -m "Update last used stream key to ${{ steps.select-key.outputs.current-key }}"
            
            # Push changes
            echo "Pushing to repository..."
            git push origin HEAD:${{ github.ref_name }}
            echo "Successfully pushed updated key state to repository"
          else
            echo "No changes to last_stream_key.txt - file already up to date"
            echo "Current value: $(cat last_stream_key.txt)"
          fi

      - name: âœ… Done
        if: always()
        run: |
          echo "=================================="
          echo "Stream finished successfully"
          echo "Video: ${{ steps.random-video.outputs.video-file }}"
          echo "Duration: ${{ steps.runtime.outputs.total-runtime }} seconds"
          echo "Streamed to: ${{ steps.select-key.outputs.current-key }}"
          echo "RTMP disconnected cleanly"
          echo "=================================="
